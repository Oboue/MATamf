 % Demo for an advanced median filter (AMF) for improving the signal-to-noise ratio of seismological datasets

% Script to plot Figure 20

%  Copyright (C) Oboue et al., 2022

%  This program is free software: you can redistribute it and/or modify
%  it under the terms of the GNU General Public License as published
%  by the Free Software Foundation, either version 3 of the License, or
%  any later version.

%  This program is distributed in the hope that it will be useful,
%  but WITHOUT ANY WARRANTY; without even the implied warranty of
%  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%  GNU General Public License for more details: http://www.gnu.org/licenses/

%  References

%  Oboue et al., 2022
%  Huang, G., M. Bai, Q. Zhao, W. Chen, and Y. Chen, 2021, Erratic noise suppression using iterative structure-oriented space-varying median filtering with sparsity constraint, Geophysical Prospecting, 69, 101-121.
%  Chen, Y., S. Zu, Y. Wang, and X. Chen, 2020, Deblending of simultaneous-source data using a structure-oriented space varying median filter, Geophysical Journal International, 222, 1805�1�723.
%  Zhao, Q., Q. Du, X. Gong, and Y. Chen, 2018, Signal-preserving erratic noise attenuation via iterative robust sparsity-promoting filter, IEEE Transactions on Geoscience and Remote Sensing, 56, 1558-0644.
%-------------------------------------------------------------------------
clc;clear;close all;
%% addpath
addpath('../amf_data/');
addpath('../amfsrcs/');
addpath('../seistr/');
%% Load the raw DAS seismic data corrupted by strong hogh-frequency noise, high-amplitude 

NOs=[1,20,10,25,11,2];
labels={...                                             %P-arrival sample NO from the SEGY file
    'FORGE\_78-32\_iDASv3-P11\_UTC190423150554.sgy',... %24169
    'FORGE\_78-32\_iDASv3-P11\_UTC190426070723.sgy',... %24811
    'FORGE\_78-32\_iDASv3-P11\_UTC190426062208.sgy',... %26090
    'FORGE\_78-32\_iDASv3-P11\_UTC190426110008.sgy',... %4921
    'FORGE\_78-32\_iDASv3-P11\_UTC190426062553.sgy',... %8934
    'FORGE\_78-32\_iDASv3-P11\_UTC190423182409.sgy'};   %4210
eq=zeros(2000,960);
[n1,n2]=size(eq);
t=[0:n1]*0.0005;

for ii=4
    
if ~ismember(NOs(ii),[14,16,17,27,47,52])
    load(strcat('amf_data/eq-',num2str(NOs(ii)),'.mat'));
end
eq=d1;
din=d1;
%% Denosing using the BP method
%  Parameter tuning for the BP method
%
dt=0.0005; % sampling
flo=0;     % Low frequency in band, default is 0
fhi=200;   % High frequency in band, default is Nyquist
nplo=6;    % number of poles for low cutoff
nphi=6;    % number of poles for high cutoff
phase=0;   % y: minimum phase, n: zero phase
verb0=0;   % verbosity flag
%
tic
d_bp=amf_bp(din,dt,flo,fhi,nplo,nphi,phase,verb0);
toc
%
%% 
%%  Denosing using the SOSVMF method
%   Parameter tuning for the BP method

niter=2;                      % number of nonlinear iterations
liter=10;                     % liter: number of linear iterations (in divn)
order1=3;                     % order: accuracy order
eps_dv=0.01;                  % eps_dv: eps for divn  (default: 0.01)
eps_cg=1;                     % eps_cg: eps for CG    (default: 1)
tol_cg=0.000001;              % tol_cg: tolerence for CG (default: 0.000001)
rect(1)=500;                   % rect:  smoothing radius (ndim*1)
rect(2)=500;                   % "      "        "
rect(3)=1;                    % "      "        "
verb1=1;                      % verbosity flag

adj=0;                        % adjoint flag
add=0;                        % adding flag
ns=20;                         % spray radius
order2=2;                     % PWD order
eps=0.01;                     % regularization (default:0.01);
ndn=n1*n2;                    % size of dn (n1*n2)
nds=n1*n2;                    % size of ds (n1*n2)
type_mf=1;                    % 0 (MF) or 1 (SVMF)
ifsmooth=0;                   % 1 (if smooth) or 0 (only MF);
% 
tic
d_sosvmf=amf_sosvmf(din,niter,liter,order1,eps_dv,eps_cg,tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth);
toc
%
%% Denoising using the dip filter in FK domain method

w=0.2;                       % half width (in percentage) of the cone filter (i.e., w*nk=nwidth)
tic
d_fk=din-amf_fk_dip(din,w);
toc
%
%% Denoising using the curvelet method 
%  Parameter tuning：add the key parameters of the curvelet method

c1=1;                % Type of the transform(0: complex-valued curvelets,1: real-valued curvelets)
c2=1;                % Chooses one of two possibilities for the coefficients at the finest level(1: curvelets,2: wavelets)
c3=3;              % Thresholding parameter (alpha)
niter1=10;           % Number of iteration
d_est=din;
% 
tic
d_ct=amf_ct(din,d_est,n1,n2,c1,c2,c3,niter1);
toc
%
%% Denoising using the AMF method 
%  Parameter tuning: add the key parameters for the local orthogonalization operation
par.dt=dt;                           % sampling
par.flo=flo;                         % Low frequency in band, default is 0
par.fhi=fhi;                         % High frequency in band, default is Nyquist
par.nplo=nplo;                       % number of poles for low cutoff
par.nphi=nphi;                       % number of poles for high cutoff
par.phase=phase;                     % y: minimum phase, n: zero phase
par.verb0=verb0;                     % verbosity flag

par.niter=niter;                     % number of nonlinear iterations
par.liter=liter;                     % liter: number of linear iterations (in divn)
par.order1=order1;                   % order: accuracy order
par.eps_dv=eps_dv;                   % eps_dv: eps for divn  (default: 0.01)
par.eps_cg=eps_cg;                   % eps_cg: eps for CG    (default: 1)
par.tol_cg=tol_cg;                   % tol_cg: tolerence for CG (default: 0.000001)
par.rect(1)=50;                      % rect:  smoothing radius (ndim*1)
par.rect(2)=50;                      % "      "        "
par.rect(3)=1;                       % "      "        "
par.verb1=verb1;                     % verbosity flag

par.adj=adj;                         % adjoint flag
par.add=add;                         % adding flag
par.ns=15;                           % spray radius
par.order2=order2;                   % PWD order
par.eps=eps;                         % regularization (default:0.01);
par.ndn=ndn;                         % size of dn (n1*n2)
par.nds=nds;                         % size of ds (n1*n2)
par.type_mf=type_mf;                 % 0 (MF) or 1 (SVMF)
par.ifsmooth=ifsmooth;               % 1 (if smooth) or 0 (only MF)

par.w=0.05;                             % half width (in percentage) of the cone filter (i.e., w*nk=nwidth)

par.c1=c1;                % Type of the transform(0: complex-valued curvelets,1: real-valued curvelets)
par.c2=c2;                % Chooses one of two possibilities for the coefficients at the finest level(1: curvelets,2: wavelets)
par.c3=0.25;                % Thresholding parameter (alpha)
par.niter1=niter1;        % Number of iteration
%
rec = zeros(3, 1);        % 3-D vector denoting smooth radius 
par.rec(1) = 150;
par.rec(2) = 150;
par.rec(3) = 1;
par.eps1=0;               % regularization parameter, default 0.0
par.niter2=20;            % number of CG iterations
par.verb=1;               % verbosity flag (default: 0) 
tic
d_amf=amf(din,par);
toc
%
%% Noise attenuation  using drr method 

flow=1/75;
fhigh=1/15;
dt=1; 
N=450;% rank
K=30;% damping factor
verb=0;

tic
d_drr=amf_fxydrr(din,flow,fhigh,dt,N,K,verb);    
toc
dn_drr=din-d_drr;

% figure('units','normalized','Position',[0.0 0.0 0.5, 1],'color','w');
% subplot(1,2,1);amf_imagesc(d_drr,100,2,x,t);caxis([-25,25]);
% subplot(1,2,2);amf_imagesc(dn_drr,100,2,x,t);caxis([-25,25]);
% amf_snr(dcl,d_drr1) % drr
end
%% Plot figures

t=[0:n1]*0.004;
x=1:n2;
ngap=5;
d_d1=[din,zeros(n1,ngap),d_bp,din-d_bp]; % BP
d_d2=[din,zeros(n1,ngap),d_sosvmf,zeros(n1,ngap),din-d_sosvmf]; % SOSVMF
d_d3=[din,zeros(n1,ngap),d_fk,zeros(n1,ngap),din-d_fk]; % FK
d_d4=[din,zeros(n1,ngap),d_ct,zeros(n1,ngap),din-d_ct]; % Curvelet
d_d5=[din,d_amf,zeros(n1,ngap),din-d_amf]; % AMF
d_d6=[din,d_drr,zeros(n1,ngap),din-d_drr]; % drr

figure('units','normalized','Position',[0.0 0.0 0.5, 1],'color','w');
subplot(3,2,1);amf_imagesc(d_d1,100,2,x,t);caxis([-25,25]);

text(n1/-20,-0.5,'(a)','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/5,-0.5,'Raw','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.5,-0.5,'BP','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
colormap(amf_seis);;caxis([-25,25]);
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Panel','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',12,'Fontweight','bold');
set(gca,'XTick',0)

subplot(3,2,2);amf_imagesc(d_d2,100,2,x,t);caxis([-25,25]);;hold on
text(n1/-20,-0.5,'(b)','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/5,-0.5,'Raw','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.5,-0.5,'SOSVMF','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
colormap(amf_seis);caxis([-25,25]);
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Panel','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',12,'Fontweight','bold');
set(gca,'XTick',0)

subplot(3,2,3);amf_imagesc(d_d3,100,2,x,t);caxis([-25,25]); hold on
text(n1/-20,-0.5,'(c)','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/5,-0.5,'Raw','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.5,-0.5,'FK','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
colormap(amf_seis);caxis([-25,25]);
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Panel','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',12,'Fontweight','bold');
set(gca,'XTick',0)

subplot(3,2,4);amf_imagesc(d_d4,100,2,x,t);caxis([-25,25]); hold on
text(n1/-20,-0.5,'(d)','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/5,-0.5,'Raw','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.5,-0.5,'Curvelet','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
colormap(amf_seis);caxis([-25,25]);
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Panel','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',12,'Fontweight','bold');
set(gca,'XTick',0)

subplot(3,2,5);amf_imagesc(d_d5,100,2,x,t);caxis([-25,25]); hold on
text(n1/-20,-0.5,'(e)','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/5,-0.5,'Raw','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.5,-0.5,'AMF','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
colormap(amf_seis);caxis([-25,25]);
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Panel','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',12,'Fontweight','bold');
set(gca,'XTick',0)

subplot(3,2,6);amf_imagesc(d_d6,100,2,x,t);caxis([-25,25]); hold on
text(n1/-20,-0.5,'(f)','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/5,-0.5,'Raw','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.5,-0.5,'DRR','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
colormap(amf_seis);caxis([-25,25]);
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Panel','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',12,'Fontweight','bold');
set(gca,'XTick',0)

annotation(gcf,'textbox',...
    [0.171 0.711481844946022 0.0245555555555556 0.0264965652600582],...
    'String','1',...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'line',[0.244444444444444 0.246666666666667],...
    [0.924435721295387 0.709519136408243],'LineWidth',3);
annotation(gcf,'textbox',...
    [0.286555555555556 0.707556427870459 0.0223333333333334 0.029440628066731],...
    'String',{'2'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'line',[0.352222222222222 0.352222222222222],...
    [0.924435721295388 0.708537782139352],'LineWidth',3);
annotation(gcf,'textbox',...
    [0.396555555555556 0.708537782139352 0.019 0.0294406280667306],...
    'String',{'3'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'textbox',...
    [0.607666666666667 0.709519136408243 0.0234444444444445 0.0274779195289495],...
    'String',{'1'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'line',[0.682222222222222 0.682222222222222],...
    [0.924417075564279 0.708537782139352],'LineWidth',3);
annotation(gcf,'textbox',...
    [0.722111111111111 0.708537782139351 0.0223333333333333 0.0284592737978402],...
    'String',{'2'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'line',[0.793333333333333 0.793333333333333],...
    [0.925417075564279 0.709519136408243],'LineWidth',3);
annotation(gcf,'textbox',...
    [0.835444444444444 0.708537782139352 0.0245555555555556 0.0294406280667314],...
    'String',{'3'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'textbox',...
    [0.171 0.41413150147203 0.0278888888888889 0.0235525024533852],...
    'String',{'1'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'line',[0.241111111111111 0.241111111111111],...
    [0.625104023552502 0.408243375858685],'LineWidth',3);
annotation(gcf,'textbox',...
    [0.284333333333333 0.412168792934249 0.0245555555555556 0.0255152109911675],...
    'String',{'2'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'line',[0.351111111111111 0.352222222222222],...
    [0.62414131501472 0.408243375858685],'LineWidth',3);
annotation(gcf,'textbox',...
    [0.392111111111111 0.409224730127576 0.0267777777777778 0.028459273797839],...
    'String',{'3'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'textbox',...
    [0.614333333333333 0.409224730127576 0.0245555555555556 0.028459273797841],...
    'String',{'1'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'line',[0.682222222222222 0.682222222222222],...
    [0.625122669283611 0.411187438665358],'LineWidth',3);
annotation(gcf,'textbox',...
    [0.726555555555556 0.409224730127575 0.0234444444444445 0.0284592737978402],...
    'String',{'2'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'line',[0.794444444444444 0.793333333333333],...
    [0.625122669283611 0.408243375858685],'LineWidth',3);
annotation(gcf,'textbox',...
    [0.833222222222222 0.410206084396467 0.0245555555555556 0.0284592737978402],...
    'String',{'3'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'textbox',...
    [0.169888888888889 0.1099116781158 0.0212222222222222 0.02747791952895],...
    'String',{'1'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'line',[0.24 0.24],[0.324828263002944 0.108930323846909],...
    'LineWidth',3);
annotation(gcf,'line',[0.24 0.24],[0.324828263002944 0.108930323846909],...
    'LineWidth',3);
annotation(gcf,'textbox',...
    [0.284333333333333 0.107948969578018 0.0245555555555556 0.0304219823356226],...
    'String',{'2'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'line',[0.354444444444444 0.353333333333333],...
    [0.326790971540726 0.108930323846909],'LineWidth',3);
annotation(gcf,'textbox',...
    [0.394333333333333 0.1099116781158 0.0256666666666667 0.0284592737978408],...
    'String',{'3'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'textbox',...
    [0.613222222222222 0.1099116781158 0.027888888888889 0.0264965652600584],...
    'String',{'1'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'line',[0.682222222222222 0.683333333333333],...
    [0.324828263002944 0.110893032384691],'LineWidth',3);
annotation(gcf,'textbox',...
    [0.725444444444444 0.1099116781158 0.0245555555555556 0.0274779195289497],...
    'String',{'2'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'line',[0.793333333333333 0.793333333333333],...
    [0.325809617271835 0.1099116781158],'LineWidth',3);
annotation(gcf,'textbox',...
    [0.835444444444444 0.111874386653582 0.0245555555555556 0.0264965652600576],...
    'String',{'3'},...
    'FontWeight','bold',...
    'FontSize',25,...
    'FitBoxToText','off',...
    'EdgeColor','none');
%%
annotation(gcf,'textarrow',[0.293333333333333 0.274444444444444],...
    [0.869461236506375 0.900883218841998],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',15,...
    'HeadLength',25,...
    'FontSize',18);
annotation(gcf,'textarrow',[0.285555555555556 0.266666666666667],...
    [0.749736015701665 0.781157998037288],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',15,...
    'HeadLength',25,...
    'FontSize',18);
annotation(gcf,'textarrow',[0.737777777777778 0.718888888888889],...
    [0.868479882237479 0.899901864573102],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',15,...
    'HeadLength',25,...
    'FontSize',18);
annotation(gcf,'textarrow',[0.728888888888889 0.71],...
    [0.756605495583903 0.788027477919526],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',15,...
    'HeadLength',25,...
    'FontSize',18);
annotation(gcf,'textarrow',[0.298888888888889 0.28],...
    [0.570148184494601 0.601570166830224],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',15,...
    'HeadLength',25,...
    'FontSize',18);
annotation(gcf,'textarrow',[0.292222222222222 0.273333333333333],...
    [0.458273797841019 0.489695780176643],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',15,...
    'HeadLength',25,...
    'FontSize',18);
annotation(gcf,'textarrow',[0.744444444444444 0.725555555555556],...
    [0.5701481844946 0.601570166830223],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',15,...
    'HeadLength',25,...
    'FontSize',18);
annotation(gcf,'textarrow',[0.731111111111111 0.712222222222223],...
    [0.455329735034347 0.48675171736997],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',15,...
    'HeadLength',25,...
    'FontSize',18);
annotation(gcf,'textarrow',[0.293333333333333 0.274444444444445],...
    [0.268872423945043 0.300294406280667],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',15,...
    'HeadLength',25,...
    'FontSize',18);
annotation(gcf,'textarrow',[0.292222222222222 0.273333333333333],...
    [0.161904808635917 0.19332679097154],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',15,...
    'HeadLength',25,...
    'FontSize',18);
annotation(gcf,'textarrow',[0.738888888888889 0.72],...
    [0.269853778213934 0.301275760549558],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',15,...
    'HeadLength',25,...
    'FontSize',18);
annotation(gcf,'textarrow',[0.728888888888889 0.71],...
    [0.160923454367026 0.192345436702649],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',15,...
    'HeadLength',25,...
    'FontSize',18);
print(gcf,'-depsc','-r300','fig20.eps');
