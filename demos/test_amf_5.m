% Demo for an advanced median filter (AMF) for improving the signal-to-noise ratio of seismological datasets
% 
%  Copyright (C) Oboue et al., 2022
%
%  This program is free software: you can redistribute it and/or modify
%  it under the terms of the GNU General Public License as published
%  by the Free Software Foundation, either version 3 of the License, or
%  any later version.
%
%  This program is distributed in the hope that it will be useful,
%  but WITHOUT ANY WARRANTY; without even the implied warranty of
%  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%  GNU General Public License for more details: http://www.gnu.org/licenses/

%  References

%  Oboue et al., 2022
%  Huang, G., M. Bai, Q. Zhao, W. Chen, and Y. Chen, 2021, Erratic noise suppression using iterative structure-oriented space-varying median filtering with sparsity constraint, Geophysical Prospecting, 69, 101-121.
%  Chen, Y., S. Zu, Y. Wang, and X. Chen, 2020, Deblending of simultaneous-source data using a structure-oriented space varying median filter, Geophysical Journal International, 222, 1805�1�723.
%  Zhao, Q., Q. Du, X. Gong, and Y. Chen, 2018, Signal-preserving erratic noise attenuation via iterative robust sparsity-promoting filter, IEEE Transactions on Geoscience and Remote Sensing, 56, 1558-0644.
%-------------------------------------------------------------------------
clc;clear;close all;
%% addpath
addpath /Users/oboue/Desktop/MATamf/amf_data/
addpath /Users/oboue/Desktop/MATamf/amfsrcs/
addpath /Users/oboue/Desktop/MATamf/seistr/
%% read field reflection seismic data 2

fid=fopen('real.bin','r');
ori=fread(fid,[800,220],'float');

dn=amf_scale(ori,2);
[n1,n2]=size(dn);
din=dn;
%%  Denosing using the BP method
%   Parameter tuning for the BP method
%
dt=0.0005; % sampling
flo=0;     % Low frequency in band, default is 0
fhi=200;   % High frequency in band, default is Nyquist
nplo=6;    % number of poles for low cutoff
nphi=6;    % number of poles for high cutoff
phase=0;   % y: minimum phase, n: zero phase
verb0=0;   % verbosity flag

%
tic
d1=amf_bandpass(din,dt,flo,fhi,nplo,nphi,phase,verb0);
toc
%
%% Denosing using the BP+SOSVMF method 
%  Parameter tuning：add the key parameters of the SOSVMF method

niter=2;                      % number of nonlinear iterations
liter=10;                     % liter: number of linear iterations (in divn)
order1=3;                     % order: accuracy order
eps_dv=0.01;                  % eps_dv: eps for divn  (default: 0.01)
eps_cg=1;                     % eps_cg: eps for CG    (default: 1)
tol_cg=0.000001;              % tol_cg: tolerence for CG (default: 0.000001)
rect(1)=50;                   % rect:  smoothing radius (ndim*1)
rect(2)=50;                   % "      "        "
rect(3)=1;                    % "      "        "
verb1=1;                      % verbosity flag

adj=0;                        % adjoint flag
add=0;                        % adding flag
ns=8;                         % spray radius
order2=2;                     % PWD order
eps=0.01;                     % regularization (default:0.01);
ndn=n1*n2;                    % size of dn (n1*n2)
nds=n1*n2;                    % size of ds (n1*n2)
type_mf=1;                    % 0 (MF) or 1 (SVMF)
ifsmooth=0;                   % 1 (if smooth) or 0 (only MF)

%                                                                                                             0,0,dipn,[],n1,n2,ns,2,0.01,n1*n2,n1*n2,type_mf,ifsmooth,d1,[]
tic
d2=amf_bandpasssosvmf(din,dt,flo,fhi,nplo,nphi,phase,verb0,niter,liter,order1,eps_dv,eps_cg,tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth);
toc
% 
%% Denoising using the BP+SOSVMF+FK method 
%  Parameter tuning：add the key parameters of the dip filter in FK domain method
%
w=0.00;   % half width (in percentage) of the cone filter (i.e., w*nk=nwidth)
%
tic
d3=amf_bandpasssosvmffk(din,dt,flo,fhi,nplo,nphi,phase,verb0,niter,liter,order1,eps_dv,eps_cg,tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth,w);
toc
%
%% Denoising data using the BP+SOSVMF+FK+curvelet method 
%  Parameter tuning：add the key parameters of the curvelet method
%
c1=1;                % Type of the transform(0: complex-valued curvelets,1: real-valued curvelets)
c2=1;                % Chooses one of two possibilities for the coefficients at the finest level(1: curvelets,2: wavelets)
c3=0.5;               % Thresholding parameter (alpha)
niter1=10;           % Number of iteration
%
tic
d4=amf_bandpasssosvmffkcurvelet(din,dt,flo,fhi,nplo,nphi,phase,verb0,niter,liter,order1,eps_dv,eps_cg,tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth,w,c1,c2,c3,niter1);
toc
%
%% Denoising using the AMF method 
%  Parameter tuning: add the key parameters for the local orthogonalization operation
%
rec = zeros(3, 1);    % 3-D vector denoting smooth radius 
rec(1) = 5;
rec(2) = 5;
rec(3) = 1;
eps1=0;               % regularization parameter, default 0.0
niter2=20;            % number of CG iterations
verb=1;               % verbosity flag (default: 0) 
%
tic
d_amf=amf(din,dt,flo,fhi,nplo,nphi,phase,verb0,niter,liter,order1,eps_dv,eps_cg,tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth,w,c1,c2,c3,niter1,rec,eps1,niter2,verb);
d5=d_amf;
toc
%% PLot figures

t=[0:n1]*0.002;
x=1:n2;
ngap=5;
ngap0=250;
d_1=[din,zeros(n1,ngap0),d1,din-d1,zeros(n1,ngap),d2,din-d2];
d_2=[d3,din-d3,zeros(n1,ngap),d4,d4-din,zeros(n1,ngap),d5,din-d5];

figure('units','normalized','Position',[0.0 0.0 0.5, 1],'color','w');
subplot(2,1,1); imagesc(x,t,d_1);colormap(amf_seis);hold on
text(n2/-200,-0.2,'(a)','color','k','Fontsize',14,'fontweight','bold','HorizontalAlignment','center');
text(n2/9.5,-0.05,'Raw','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
text(n2/2.0,-0.05,'BP','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.17,-0.05,'BP+SOSVMF','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
annotation(gcf,'rectangle',...
    [0.12995951417004 0.239327296248383 0.7758987854251 0.104786545924968],...
    'LineWidth',3);
colormap(amf_seis);caxis([-0.6,0.6]);
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Trace','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',15,'Fontweight','bold');

subplot(2,1,2); imagesc(x,t,d_2);colormap(amf_seis);hold on
text(n2/-200,-0.2,'(b)','color','k','Fontsize',14,'fontweight','bold','HorizontalAlignment','center');
text(n2/6.0,-0.05,'BP+SOSVMF+FK','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
text(n2/2.0,-0.05,'BP+SOSVMF+FK+Curvelet','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.19,-0.05,'AMF','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
annotation(gcf,'rectangle',...
    [0.130769230769231 0.712807244501941 0.774684210526314 0.104786545924968],...
    'LineWidth',3);
colormap(amf_seis);caxis([-0.6,0.6]);
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Trace','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',15,'Fontweight','bold');
print(gcf,'-depsc','-r300','fig10.pdf');
print(gcf,'-depsc','-r300','fig10.eps');
%% zoomed sections
inds1=250:500;

figure('units','normalized','Position',[0.0 0.0 0.5, 1],'color','w');
subplot(2,1,1);amf_imagesc(d_1(inds1,:),25,2,x,t(inds1));
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Trace','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',15,'Fontweight','bold');
colormap(amf_seis);caxis([-0.6,0.6]);
annotation(gcf,'textbox',...
    [0.127296124749109 0.872472783825817 0.0671920642272688 0.0357698289269052],...
    'Color',[1 0 0],...
    'String',{'Random','  noise'},...
    'FontWeight','bold',...
    'FontSize',12,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'textarrow',[0.14078431372549 0.150588235294117],...
    [0.818818040435458 0.83670295489891],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.173333333333329 0.167450980392156],...
    [0.713557726457266 0.741057542768274],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'      High-amplitude','erratic noise'},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.409411764705882 0.419215686274509],...
    [0.818040435458787 0.835925349922238],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.442352941176467 0.436470588235293],...
    [0.717445751340625 0.744945567651633],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'      High-amplitude','erratic noise'},...
    'LineWidth',3,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.509803921568622 0.50352941176469],...
    [0.863141524105754 0.847589424572317],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Weaker','signal energy'},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.531764705882349 0.527843137254872],...
    [0.733281493001556 0.760497667185069],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.568627450980386 0.567058823529389],...
    [0.843701399688958 0.816485225505442],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.586666666666651 0.596470588235278],...
    [0.723172628304821 0.741057542768272],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.627058823529404 0.63686274509803],...
    [0.669517884914464 0.687402799377915],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.693725490196061 0.687843137254887],...
    [0.713557726457266 0.741057542768274],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.66156862745097 0.671372549019597],...
    [0.821928460342146 0.839813374805597],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.761176470588229 0.754901960784298],...
    [0.875583203732504 0.860031104199066],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.785882352941158 0.781960784313681],...
    [0.733281493001555 0.760497667185068],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.82156862745096 0.819999999999964],...
    [0.846034214618973 0.818818040435457],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.870980392156844 0.88078431372547],...
    [0.818040435458787 0.835925349922238],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Stronger','signal','leakage'},...
    'LineWidth',2,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.842745098039187 0.852549019607814],...
    [0.723950233281493 0.741835147744944],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.880784313725471 0.890588235294098],...
    [0.664852255054433 0.682737169517884],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);

subplot(2,1,2);amf_imagesc(d_2(inds1,:),25,2,x,t(inds1));
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Trace','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',15,'Fontweight','bold');
colormap(amf_seis);caxis([-0.6,0.6]); 

annotation(gcf,'textarrow',[0.265490196078426 0.261568627450949],...
    [0.255832037325039 0.283048211508552],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.301960784313717 0.30039215686272],...
    [0.365474339035769 0.338258164852253],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.351764705882333 0.36156862745096],...
    [0.337480559875583 0.355365474339034],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.324705882352925 0.334509803921552],...
    [0.238724727838258 0.256609642301709],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.363921568627441 0.373725490196068],...
    [0.177293934681183 0.195178849144634],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.39921568627451 0.409019607843136],...
    [0.335147744945568 0.353032659409019],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.436470588235291 0.430588235294117],...
    [0.235330665804078 0.262830482115086],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.49960784313725 0.493333333333318],...
    [0.398133748055988 0.38258164852255],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.525098039215681 0.521176470588204],...
    [0.252721617418352 0.279937791601865],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.558823529411757 0.55725490196076],...
    [0.372472783825816 0.3452566096423],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.579215686274494 0.589019607843121],...
    [0.241835147744946 0.259720062208397],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.609019607843117 0.618823529411744],...
    [0.342923794712286 0.360808709175737],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.758431372549015 0.752156862745083],...
    [0.397356143079316 0.381804043545878],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Improved','signal energy'},...
    'LineWidth',3,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.784705882352934 0.780784313725457],...
    [0.254276827371695 0.281493001555208],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.824313725490176 0.822745098039179],...
    [0.369362363919128 0.342146189735613],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.870588235294099 0.880392156862725],...
    [0.340590979782271 0.358475894245722],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Weaker','signal','leakage'},...
    'LineWidth',2,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.843921568627435 0.853725490196061],...
    [0.251166407465008 0.269051321928459],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.879607843137245 0.889411764705872],...
    [0.192068429237948 0.209953343701399],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'HeadWidth',10,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.621340126601812 0.631144048170439],...
    [0.185069984447901 0.202954898911352],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',2,...
    'FontWeight','bold',...
    'FontSize',12);

text(n2/-200,-0.25,'(a)','color','k','Fontsize',14,'fontweight','bold','HorizontalAlignment','center');
text(n2/9.5,-0.22,'Raw','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
text(n2/2.0,-0.22,'BP','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.19,-0.22,'BP+SOSVMF','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');

text(n2/-200,0.45,'(b)','color','k','Fontsize',14,'fontweight','bold','HorizontalAlignment','center');
text(n2/6.0,0.48,'BP+SOSVMF+FK','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
text(n2/2.0,0.48,'BP+SOSVMF+FK+Curvelet','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.19,0.48,'AMF','color','k','Fontsize',12,'fontweight','bold','HorizontalAlignment','center');

print(gcf,'-depsc','-r300','fig11.pdf');
print(gcf,'-depsc','-r300','fig11.eps');
%% local similarity maps
rect=[10,10,1];niter=20;eps=0;verb=0;
[simid1]=amf_localsimi(dn-d1,d1,rect,niter,eps,verb);
[simid2]=amf_localsimi(dn-d2,d2,rect,niter,eps,verb);
[simid3]=amf_localsimi(dn-d3,d3,rect,niter,eps,verb);
[simid4]=amf_localsimi(dn-d4,d4,rect,niter,eps,verb); 
[simid5]=amf_localsimi(dn-d5,d5,rect,niter,eps,verb);

d_sim=[simid1,zeros(n1,ngap),simid2,zeros(n1,ngap),simid3,zeros(n1,ngap),simid4,zeros(n1,ngap),simid5];
%% Plot figures
figure('units','normalized','Position',[0.0 0.0 0.5, 1],'color','w');
imagesc(x,t,d_sim);colormap(jet);hold on
text(n2/9,-0.02,'BP','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
text(n2/3.25,-0.02,'BP+SOSVMF','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
text(n2/2,-0.02,'BP+SOSVMF+FK','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.40,-0.02,'BP+SOSVMF+FK+Curvelet','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.10,-0.02,'AMF','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
c = colorbar;c.Label.String = 'Local similarity';c.Label.FontSize = 16;%c.Label.FontWeight = bold;
caxis([0,1]);
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Trace','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',15,'Fontweight','bold');
print(gcf,'-depsc','-r300','fig12.pdf');
print(gcf,'-depsc','-r300','fig12.eps');


















