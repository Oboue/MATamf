% Demo for an advanced median filter (AMF) for improving the signal-to-noise ratio of seismological datasets

% Script to plot Figures 8, 9, 10, 11, 12 and 13

%  Copyright (C) Oboue et al., 2022

%  This program is free software: you can redistribute it and/or modify
%  it under the terms of the GNU General Public License as published
%  by the Free Software Foundation, either version 3 of the License, or
%  any later version.

%  This program is distributed in the hope that it will be useful,
%  but WITHOUT ANY WARRANTY; without even the implied warranty of
%  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%  GNU General Public License for more details: http://www.gnu.org/licenses/

%  References

%  Oboue et al., 2022
%  Huang, G., M. Bai, Q. Zhao, W. Chen, and Y. Chen, 2021, Erratic noise suppression using iterative structure-oriented space-varying median filtering with sparsity constraint, Geophysical Prospecting, 69, 101-121.
%  Chen, Y., S. Zu, Y. Wang, and X. Chen, 2020, Deblending of simultaneous-source data using a structure-oriented space varying median filter, Geophysical Journal International, 222, 1805�1�723.
%  Zhao, Q., Q. Du, X. Gong, and Y. Chen, 2018, Signal-preserving erratic noise attenuation via iterative robust sparsity-promoting filter, IEEE Transactions on Geoscience and Remote Sensing, 56, 1558-0644.
%-------------------------------------------------------------------------
clc;clear;close all;
%% addpath
addpath('../amf_data/');
addpath('../amfsrcs/');
addpath('../seistr/');

%% read field reflection seismic data 1
fid=fopen('real2.bin','r');
d2d=fread(fid,[256,256],'float');

dn=amf_scale(d2d,2);
[n1,n2]=size(dn);
din1=dn;
%%  Denosing using the BP method
% Parameter tuning for the BP method
%
dt=0.0005; % sampling
flo=0;     % Low frequency in band, default is 0
fhi=200;   % High frequency in band, default is Nyquist
nplo=6;    % number of poles for low cutoff
nphi=6;    % number of poles for high cutoff
phase=0;   % y: minimum phase, n: zero phase
verb0=0;   % verbosity flag
%
tic
d1_bp=amf_bandpass(din1,dt,flo,fhi,nplo,nphi,phase,verb0);
toc
%
%% Denosing using the BP+SOSVMF method 
% Parameter tuning：add the key parameters of the SOSVMF method

niter=2;                      % number of nonlinear iterations
liter=10;                     % liter: number of linear iterations (in divn)
order1=3;                     % order: accuracy order
eps_dv=0.01;                  % eps_dv: eps for divn  (default: 0.01)
eps_cg=1;                     % eps_cg: eps for CG    (default: 1)
tol_cg=0.000001;              % tol_cg: tolerence for CG (default: 0.000001)
rect(1)=50;                   % rect:  smoothing radius (ndim*1)
rect(2)=50;                   % "      "        "
rect(3)=1;                    % "      "        "
verb1=1;                      % verbosity flag

adj=0;                        % adjoint flag
add=0;                        % adding flag
ns=8;                         % spray radius
order2=2;                     % PWD order
eps=0.01;                     % regularization (default:0.01);
ndn=n1*n2;                    % size of dn (n1*n2)
nds=n1*n2;                    % size of ds (n1*n2)
type_mf=1;                    % 0 (MF) or 1 (SVMF)
ifsmooth=0;                   % 1 (if smooth) or 0 (only MF)

%
tic
d1_bpsosvmf=amf_bandpasssosvmf(din1,dt,flo,fhi,nplo,nphi,phase,verb0,niter,liter,order1,eps_dv,eps_cg,tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth);
toc
%

%% Denoising using the BP+SOSVMF+FK method 
%  Parameter tuning：add the key parameters of the dip filter in FK domain method
%
w=0.00;   % half width (in percentage) of the cone filter (i.e., w*nk=nwidth)
%
tic
d1_bpsosvmffk=amf_bandpasssosvmffk(din1,dt,flo,fhi,nplo,nphi,phase,verb0,niter,liter,order1,eps_dv,eps_cg,tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth,w);
toc
%
%% Denoising data using the BP+SOSVMF+FK+curvelet method 
%  Parameter tuning：add the key parameters of the curvelet method
%
c1=1;                % Type of the transform(0: complex-valued curvelets,1: real-valued curvelets)
c2=1;                % Chooses one of two possibilities for the coefficients at the finest level(1: curvelets,2: wavelets)
c3=0.5;               % Thresholding parameter (alpha)
niter1=10;           % Number of iteration
% 
tic
d1_bpsosvmffkcurvelet=amf_bandpasssosvmffkcurvelet(din1,dt,flo,fhi,nplo,nphi,phase,verb0,niter,liter,order1,eps_dv,eps_cg,tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth,w,c1,c2,c3,niter1);
toc
%
%% Denoising using the AMF method 
%  Parameter tuning: add the key parameters for the local orthogonalization operation

par.dt=0.0005; % sampling
par.flo=0;     % Low frequency in band, default is 0
par.fhi=200;   % High frequency in band, default is Nyquist
par.nplo=6;    % number of poles for low cutoff
par.nphi=6;    % number of poles for high cutoff
par.phase=0;   % y: minimum phase, n: zero phase
par.verb0=0;   % verbosity flag

par.niter=niter;                 % number of nonlinear iterations
par.liter=liter;                 % liter: number of linear iterations (in divn)
par.order1=order1;               % order: accuracy order
par.eps_dv=eps_dv;               % eps_dv: eps for divn  (default: 0.01)
par.eps_cg=eps_cg;               % eps_cg: eps for CG    (default: 1)
par.tol_cg=tol_cg;               % tol_cg: tolerence for CG (default: 0.000001)
par.rect(1)=rect(1);             % rect:  smoothing radius (ndim*1)
par.rect(2)=rect(2);             % "      "        "
par.rect(3)=rect(3);             % "      "        "
par.verb1=verb1;                 % verbosity flag

par.adj=adj;                     % adjoint flag
par.add=add;                     % adding flag
par.ns=ns;                       % spray radius
par.order2=order2;               % PWD order
par.eps=eps;                     % regularization (default:0.01);
par.ndn=ndn;                     % size of dn (n1*n2)
par.nds=nds;                     % size of ds (n1*n2)
par.type_mf=type_mf;             % 0 (MF) or 1 (SVMF)
par.ifsmooth=ifsmooth;                   % 1 (if smooth) or 0 (only MF)

par.w=w;                        % half width (in percentage) of the cone filter (i.e., w*nk=nwidth)

par.c1=c1;                      % Type of the transform(0: complex-valued curvelets,1: real-valued curvelets)
par.c2=c2;                      % Chooses one of two possibilities for the coefficients at the finest level(1: curvelets,2: wavelets)
par.c3=c3;                      % Thresholding parameter (alpha)
par.niter1=niter1;              % Number of iteration

%

rec = zeros(3, 1);    % 3-D vector denoting smooth radius 
par.rec(1) = 10;
par.rec(2) = 10;
par.rec(3) = 1;
par.eps1=0;               % regularization parameter, default 0.0
par.niter2=20;            % number of CG iterations
par.verb=1;               % verbosity flag (default: 0) 
%tic
d1_amf=amf(din1,par);
toc
%%
% Plot figures

t=[0:n1]*0.004;
x=1:n2;
ngap=10;
ngap0=250;
d1_1=[din1,zeros(n1,ngap0),d1_bp,din1-d1_bp,zeros(n1,ngap),d1_bpsosvmf,din1-d1_bpsosvmf];
d1_2=[d1_bpsosvmffk,din1-d1_bpsosvmffk,zeros(n1,ngap),d1_bpsosvmffkcurvelet,d1_bpsosvmffkcurvelet-din1,zeros(n1,ngap),d1_amf,din1-d1_amf];
%% local similarity maps

rect=[10,10,1];niter=20;eps=0;verb=0;
[simid11]=amf_localsimi(din1-d1_bp,d1_bp,rect,niter,eps,verb);
[simid12]=amf_localsimi(din1-d1_bpsosvmf,d1_bpsosvmf,rect,niter,eps,verb);
[simid13]=amf_localsimi(din1-d1_bpsosvmffk,d1_bpsosvmffk,rect,niter,eps,verb);
[simid14]=amf_localsimi(din1-d1_bpsosvmffkcurvelet,d1_bpsosvmffkcurvelet,rect,niter,eps,verb);
[simid15]=amf_localsimi(din1-d1_amf,d1_amf,rect,niter,eps,verb);
d1_sim=[simid11,zeros(n1,ngap),simid12,zeros(n1,ngap),simid13,zeros(n1,ngap),simid14,zeros(n1,ngap),simid15];
%% read field reflection seismic data 2

fid=fopen('real.bin','r');
ori=fread(fid,[800,220],'float');

dn=amf_scale(ori,2);
[n1,n2]=size(dn)
din2=dn;
%%  Denosing using the BP method
% Parameter tuning for the BP method
%
dt=0.0005; % sampling
flo=0;     % Low frequency in band, default is 0
fhi=200;   % High frequency in band, default is Nyquist
nplo=6;    % number of poles for low cutoff
nphi=6;    % number of poles for high cutoff
phase=0;   % y: minimum phase, n: zero phase
verb0=0;   % verbosity flag
%
tic
d2_bp=amf_bandpass(din2,dt,flo,fhi,nplo,nphi,phase,verb0);
toc
%
%% Denosing using the BP+SOSVMF method 
% Parameter tuning：add the key parameters of the SOSVMF method

niter=2;                      % number of nonlinear iterations
liter=10;                     % liter: number of linear iterations (in divn)
order1=3;                     % order: accuracy order
eps_dv=0.01;                  % eps_dv: eps for divn  (default: 0.01)
eps_cg=1;                     % eps_cg: eps for CG    (default: 1)
tol_cg=0.000001;              % tol_cg: tolerence for CG (default: 0.000001)
rect(1)=50;                   % rect:  smoothing radius (ndim*1)
rect(2)=50;                   % "      "        "
rect(3)=1;                    % "      "        "
verb1=1;                      % verbosity flag

adj=0;                        % adjoint flag
add=0;                        % adding flag
ns=8;                         % spray radius
order2=2;                     % PWD order
eps=0.01;                     % regularization (default:0.01);
ndn=n1*n2;                    % size of dn (n1*n2)
nds=n1*n2;                    % size of ds (n1*n2)
type_mf=1;                    % 0 (MF) or 1 (SVMF)
ifsmooth=0;                   % 1 (if smooth) or 0 (only MF)
%                                                                                                             0,0,dipn,[],n1,n2,ns,2,0.01,n1*n2,n1*n2,type_mf,ifsmooth,d1,[]
tic
d2_bpsosvmf=amf_bandpasssosvmf(din2,dt,flo,fhi,nplo,nphi,phase,verb0,niter,liter,order1,eps_dv,eps_cg,tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth);
toc
% 
%% Denoising using the BP+SOSVMF+FK method 
%  Parameter tuning：add the key parameters of the dip filter in FK domain method
%
w=0.00;   % half width (in percentage) of the cone filter (i.e., w*nk=nwidth)
% 
tic
d2_bpsosvmffk=amf_bandpasssosvmffk(din2,dt,flo,fhi,nplo,nphi,phase,verb0,niter,liter,order1,eps_dv,eps_cg,tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth,w);
toc
%
%% Denoising data using the BP+SOSVMF+FK+curvelet method 
%  Parameter tuning：add the key parameters of the curvelet method
%
c1=1;                % Type of the transform(0: complex-valued curvelets,1: real-valued curvelets)
c2=1;                % Chooses one of two possibilities for the coefficients at the finest level(1: curvelets,2: wavelets)
c3=0.5;               % Thresholding parameter (alpha)
niter1=10;           % Number of iteration
% 
tic
d2_bpsosvmffkcurvelet=amf_bandpasssosvmffkcurvelet(din2,dt,flo,fhi,nplo,nphi,phase,verb0,niter,liter,order1,eps_dv,eps_cg,tol_cg,rect,verb1,adj,add,n1,n2,ns,order2,eps,ndn,nds,type_mf,ifsmooth,w,c1,c2,c3,niter1);
toc
%
%% Denoising using the AMF method 
%  Parameter tuning: add the key parameters for the local orthogonalization operation

par.dt=0.0005; % sampling
par.flo=0;     % Low frequency in band, default is 0
par.fhi=200;   % High frequency in band, default is Nyquist
par.nplo=6;    % number of poles for low cutoff
par.nphi=6;    % number of poles for high cutoff
par.phase=0;   % y: minimum phase, n: zero phase
par.verb0=0;   % verbosity flag

par.niter=niter;                 % number of nonlinear iterations
par.liter=liter;                 % liter: number of linear iterations (in divn)
par.order1=order1;               % order: accuracy order
par.eps_dv=eps_dv;               % eps_dv: eps for divn  (default: 0.01)
par.eps_cg=eps_cg;               % eps_cg: eps for CG    (default: 1)
par.tol_cg=tol_cg;               % tol_cg: tolerence for CG (default: 0.000001)
par.rect(1)=rect(1);             % rect:  smoothing radius (ndim*1)
par.rect(2)=rect(2);             % "      "        "
par.rect(3)=rect(3);             % "      "        "
par.verb1=verb1;                 % verbosity flag

par.adj=adj;                     % adjoint flag
par.add=add;                     % adding flag
par.ns=ns;                       % spray radius
par.order2=order2;               % PWD order
par.eps=eps;                     % regularization (default:0.01);
par.ndn=ndn;                     % size of dn (n1*n2)
par.nds=nds;                     % size of ds (n1*n2)
par.type_mf=type_mf;             % 0 (MF) or 1 (SVMF)
par.ifsmooth=ifsmooth;                   % 1 (if smooth) or 0 (only MF)

par.w=w;                        % half width (in percentage) of the cone filter (i.e., w*nk=nwidth)

par.c1=c1;                      % Type of the transform(0: complex-valued curvelets,1: real-valued curvelets)
par.c2=c2;                      % Chooses one of two possibilities for the coefficients at the finest level(1: curvelets,2: wavelets)
par.c3=c3;                      % Thresholding parameter (alpha)
par.niter1=niter1;              % Number of iteration
%
rec = zeros(3, 1);    % 3-D vector denoting smooth radius 
par.rec(1) = 10;
par.rec(2) = 10;
par.rec(3) = 1;
par.eps1=0;               % regularization parameter, default 0.0
par.niter2=20;            % number of CG iterations
par.verb=1;               % verbosity flag (default: 0) 
%tic
d2_amf=amf(din2,par);
toc 
%%
t=[0:n1]*0.002;
x=1:n2;
ngap=5;
ngap0=250;
d2_1=[din2,zeros(n1,ngap0),d2_bp,din2-d2_bp,zeros(n1,ngap),d2_bpsosvmf,din2-d2_bpsosvmf];
d2_2=[d2_bpsosvmffk,din2-d2_bpsosvmffk,zeros(n1,ngap),d2_bpsosvmffkcurvelet,din2-d2_bpsosvmffkcurvelet,zeros(n1,ngap),d2_amf,din2-d2_amf];
%% local similarity maps
rect=[10,10,1];niter=20;eps=0;verb=0;
[simid21]=amf_localsimi(din2-d2_bp,d2_bp,rect,niter,eps,verb);
[simid22]=amf_localsimi(din2-d2_bpsosvmf,d2_bpsosvmf,rect,niter,eps,verb);
[simid23]=amf_localsimi(din2-d2_bpsosvmffk,d2_bpsosvmffk,rect,niter,eps,verb);
[simid24]=amf_localsimi(din2-d2_bpsosvmffkcurvelet,d2_bpsosvmffkcurvelet,rect,niter,eps,verb);
[simid25]=amf_localsimi(din2-d2_amf,d2_amf,rect,niter,eps,verb);
d_sim2=[simid21,zeros(n1,ngap),simid22,zeros(n1,ngap),simid23,zeros(n1,ngap),simid24,zeros(n1,ngap),simid25];
%% Plot figures/ first field data

figure('units','normalized','Position',[0.0 0.0 0.5, 1],'color','w');
subplot(2,1,1); imagesc(x,t,d1_1);colormap(amf_seis);hold on
text(n1/-70,-0.1,'(a)','color','k','Fontsize',20,'fontweight','bold','HorizontalAlignment','center');
text(n2/9.5,-0.05,'Raw','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/2.0,-0.05,'BP','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.17,-0.05,'BP+SOSVMF','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
ylabel('Time (s)','Fontsize',16,'fontweight','bold');
xlabel('Trace','Fontsize',16,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',16,'Fontweight','bold');
colormap(amf_seis);caxis([-0.4,0.4]);
annotation(gcf,'rectangle',...
    [0.130769230769231 0.790426908150065 0.774684210526315 0.0685640362225094],...
    'LineWidth',3);
annotation(gcf,'textarrow',[0.464444444444444 0.491111111111111],...
    [0.653582074521652 0.695871097683787],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'High-amplitude','erratic noise'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textarrow',[0.836666666666667 0.863333333333333],...
    [0.768385699899295 0.81067472306143],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Visible','signal','leakage'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textarrow',[0.836666666666667 0.863333333333333],...
    [0.640490433031218 0.682779456193353],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
subplot(2,1,2); imagesc(x,t,d1_2);colormap(amf_seis);hold on
text(n1/-70,-0.1,'(b)','color','k','Fontsize',20,'fontweight','bold','HorizontalAlignment','center');
text(n2/6.0,-0.05,'BP+SOSVMF+FK','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/2.0,-0.05,'BP+SOSVMF+FK+Curvelet','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.19,-0.05,'AMF','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
ylabel('Time (s)','Fontsize',16,'fontweight','bold');
xlabel('Trace','Fontsize',16,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',16,'Fontweight','bold');
colormap(amf_seis);caxis([-0.4,0.4]);
annotation(gcf,'rectangle',...
    [0.13036437246964 0.316946959896517 0.774684210526313 0.0685640362225092],...
    'LineWidth',3);
annotation(gcf,'textarrow',[0.316666666666667 0.343333333333333],...
    [0.297086606243706 0.339375629405841],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Visible','signal','leakage'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textarrow',[0.577777777777778 0.604444444444444],...
    [0.296079556898288 0.338368580060423],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Visible','signal','leakage'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textarrow',[0.838888888888889 0.865555555555555],...
    [0.302121852970796 0.344410876132931],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
print(gcf,'-depsc','-r300','fig8.eps');

%% zoomed sections
inds1=50:100;
figure('units','normalized','Position',[0.0 0.0 0.5, 1],'color','w');
subplot(2,1,1);amf_imagesc(d1_1(inds1,:),25,2,x,t(inds1));
ylabel('Time (s)','Fontsize',16,'fontweight','bold');
xlabel('Trace','Fontsize',16,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',16,'Fontweight','bold');
colormap(amf_seis);caxis([-0.4,0.4]);

subplot(2,1,2);amf_imagesc(d1_2(inds1,:),25,2,x,t(inds1));
ylabel('Time (s)','Fontsize',16,'fontweight','bold');
xlabel('Trace','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',16,'Fontweight','bold');
colormap(amf_seis);caxis([-0.4,0.4]);

annotation(gcf,'textarrow',[0.221996527777785 0.236840277777778],...
    [0.865273871608103 0.836008524622066],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'      High-amplitude','erratic noise'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textbox',...
    [0.147666666666667 0.639757820383451 0.089 0.0460677983656963],...
    'Color',[1 0 0],...
    'String',{'Random','  noise'},...
    'FontWeight','bold',...
    'FontSize',18,...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'textarrow',[0.462222222222222 0.49140625],...
    [0.858728557013119 0.832276648467625],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold');
annotation(gcf,'textarrow',[0.461111111111111 0.490295138888889],...
    [0.685166498486378 0.658714589940883],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold');
annotation(gcf,'textarrow',[0.803454861111111 0.803454861111112],...
    [0.839581898046654 0.874574121996887],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Visible','signal','leakage'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textarrow',[0.284565972222222 0.284565972222223],...
    [0.369349809247461 0.404342033197694],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Visible','signal','leakage'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'arrow',[0.568376068376067 0.559649474246509],...
    [0.231222144439776 0.280587218649772],'Color',[1 0 0],'LineWidth',2);
annotation(gcf,'textarrow',[0.613281250000001 0.613281250000002],...
    [0.384914463452566 0.419906687402799],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',2,...
    'HeadWidth',8,...
    'FontWeight','bold');
annotation(gcf,'textarrow',[0.636788194444444 0.636788194444445],...
    [0.295686842547159 0.330679066497392],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Visible','signal','leakage'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textarrow',[0.752065972222223 0.726666666666667],...
    [0.393052244696828 0.319878910191726],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Improved','signal energy'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);

text(n1/-50,-0.05,'(a)','color','k','Fontsize',20,'fontweight','bold','HorizontalAlignment','center');
text(n2/9.5,-0.048,'Raw','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/2.0,-0.048,'BP','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.19,-0.048,'BP+SOSVMF','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');

text(n1/-50,0.09,'(b)','color','k','Fontsize',20,'fontweight','bold','HorizontalAlignment','center');
text(n2/6.0,0.0935,'BP+SOSVMF+FK','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/2.0,0.0935,'BP+SOSVMF+FK+Curvelet','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.19,0.0935,'AMF','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');

print(gcf,'-depsc','-r300','fig9.eps');
%%
figure('units','normalized','Position',[0.0 0.0 0.5, 1],'color','w');
imagesc(x,t,d1_sim);colormap(jet);hold on
text(n2/9,-0.018,'BP','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
text(n2/3.25,-0.018,'BP+SOSVMF','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
text(n2/2,-0.018,'BP+SOSVMF+FK','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.40,-0.018,'BP+SOSVMF+Curvelet','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.10,-0.018,'AMF','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');

c = colorbar;c.Label.String = 'Local similarity';c.Label.FontSize = 16;%c.Label.FontWeight = bold;
caxis([0,0.5]);
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Trace','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',15,'Fontweight','bold');

print(gcf,'-depsc','-r300','fig10.eps');
%% Plot figures/second field data
figure('units','normalized','Position',[0.0 0.0 0.5, 1],'color','w');
subplot(2,1,1); imagesc(x,t,d2_1);colormap(amf_seis);hold on
text(n1/-50,-0.1,'(a)','color','k','Fontsize',20,'fontweight','bold','HorizontalAlignment','center');
text(n2/9.8,-0.05,'Raw','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/2.0,-0.05,'BP','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.17,-0.05,'BP+SOSVMF','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
annotation(gcf,'rectangle',...
    [0.12995951417004 0.239327296248383 0.7758987854251 0.104786545924968],...
    'LineWidth',3);
annotation(gcf,'textarrow',[0.456666666666667 0.494444444444444],...
    [0.883189325276939 0.896273917421954],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Stronger','signal','leakage'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textarrow',[0.603333333333333 0.594444444444445],...
    [0.860027190332326 0.83987915407855],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Stronger signal','leakage'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textarrow',[0.842222222222222 0.833333333333333],...
    [0.872111782477341 0.851963746223565],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
colormap(amf_seis);caxis([-0.4,0.4]);
ylabel('Time (s)','Fontsize',16,'fontweight','bold');
xlabel('Trace','Fontsize',16,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',16,'Fontweight','bold');
subplot(2,1,2); imagesc(x,t,d2_2);colormap(amf_seis);hold on
text(n1/-50,-0.1,'(b)','color','k','Fontsize',20,'fontweight','bold','HorizontalAlignment','center');
text(n2/6.0,-0.05,'BP+SOSVMF+FK','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/2.0,-0.05,'BP+SOSVMF+FK+Curvelet','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.19,-0.05,'AMF','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
annotation(gcf,'rectangle',...
    [0.130769230769231 0.712807244501941 0.774684210526314 0.104786545924968],...
    'LineWidth',3);
colormap(amf_seis);caxis([-0.4,0.4]);
annotation(gcf,'textarrow',[0.325555555555555 0.316666666666667],...
    [0.400812688821752 0.380664652567976],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textarrow',[0.573333333333334 0.564444444444445],...
    [0.409876132930514 0.389728096676737],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textarrow',[0.82 0.831111111111111],...
    [0.408869083585096 0.381671701913394],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Weaker','signal leakage'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);

ylabel('Time (s)','Fontsize',16,'fontweight','bold');
xlabel('Trace','Fontsize',16,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',16,'Fontweight','bold');

print(gcf,'-depsc','-r300','fig11.eps');
%% zoomed sections
inds1=250:500;

figure('units','normalized','Position',[0.0 0.0 0.5, 1],'color','w');
subplot(2,1,1);amf_imagesc(d2_1(inds1,:),25,2,x,t(inds1));
ylabel('Time (s)','Fontsize',16,'fontweight','bold');
xlabel('Trace','Fontsize',16,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',16,'Fontweight','bold');
colormap(amf_seis);caxis([-0.4,0.4]);
annotation(gcf,'textbox',...
    [0.122851680304665 0.841893252769386 0.0815927641397799 0.0542647678383215],...
    'Color',[1 0 0],...
    'String',{'Random','  noise'},...
    'FontWeight','bold',...
    'FontSize',18,...
    'FontName','Helvetica Neue',...
    'FitBoxToText','off',...
    'EdgeColor','none');
annotation(gcf,'textarrow',[0.191111111111107 0.176666666666667],...
    [0.680325098058475 0.722054380664653],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'      High-amplitude','erratic noise'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textarrow',[0.509803921568622 0.504444444444444],...
    [0.863141524105754 0.832829808660624],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Weaker','signal energy'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.581111111111111 0.567058823529389],...
    [0.837865055387714 0.813464077469188],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.608888888888889 0.628888888888889],...
    [0.765357502517623 0.796576032225579],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Stronger','signal',' leakage'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.461111111111107 0.446666666666667],...
    [0.683346246094728 0.725075528700906],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'      High-amplitude','erratic noise'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18);
annotation(gcf,'textarrow',[0.771111111111111 0.757058823529389],...
    [0.865055387713998 0.840654409795472],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.835555555555556 0.821503267973833],...
    [0.835850956696878 0.811449978778353],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.87 0.89],...
    [0.750251762336354 0.78147029204431],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18,...
    'FontName','Helvetica Neue');
subplot(2,1,2);amf_imagesc(d2_2(inds1,:),25,2,x,t(inds1));
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Trace','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',15,'Fontweight','bold');
colormap(amf_seis);caxis([-0.4,0.4]);
annotation(gcf,'textarrow',[0.25 0.235947712418278],...
    [0.392749244712991 0.368348266794465],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',12);
annotation(gcf,'textarrow',[0.277777777777778 0.264444444444444],...
    [0.245720040281974 0.280966767371601],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.282222222222222 0.31111111111111],...
    [0.375629405840886 0.406847935548842],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.541111111111111 0.57],...
    [0.375629405840886 0.406847935548842],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.59 0.618888888888888],...
    [0.331319234642497 0.362537764350453],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.534444444444444 0.521111111111111],...
    [0.248741188318228 0.283987915407855],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.765359477124178 0.76],...
    [0.375729640923478 0.345417925478348],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Improved signal',' energy'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.863333333333333 0.892222222222222],...
    [0.274924471299094 0.30614300100705],'Color',[1 0 0],'TextColor',[1 0 0],...
    'String',{'Weaker','signal','leakage'},...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18,...
    'FontName','Helvetica Neue');
annotation(gcf,'textarrow',[0.336666666666667 0.365555555555555],...
    [0.304128902316213 0.335347432024169],'Color',[1 0 0],'TextColor',[1 0 0],...
    'LineWidth',3,...
    'HeadWidth',25,...
    'HeadLength',15,...
    'FontWeight','bold',...
    'FontSize',18,...
    'FontName','Helvetica Neue');

text(n1/-50,-0.23,'(a)','color','k','Fontsize',20,'fontweight','bold','HorizontalAlignment','center');
text(n2/9.5,-0.22,'Raw','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/2.0,-0.22,'BP','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.19,-0.22,'BP+SOSVMF','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');

text(n1/-50,0.46,'(b)','color','k','Fontsize',20,'fontweight','bold','HorizontalAlignment','center');
text(n2/6.0,0.48,'BP+SOSVMF+FK','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/2.0,0.48,'BP+SOSVMF+FK+Curvelet','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.19,0.48,'AMF','color','k','Fontsize',16,'fontweight','bold','HorizontalAlignment','center');
print(gcf,'-depsc','-r300','fig12.eps');
%%
figure('units','normalized','Position',[0.0 0.0 0.5, 1],'color','w');
imagesc(x,t,d_sim2);colormap(jet);hold on
text(n2/9,-0.02,'BP','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
text(n2/3.25,-0.02,'BP+SOSVMF','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
text(n2/2,-0.02,'BP+SOSVMF+FK','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.40,-0.02,'BP+SOSVMF+FK+Curvelet','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
text(n2/1.10,-0.02,'AMF','color','k','Fontsize',10,'fontweight','bold','HorizontalAlignment','center');
c = colorbar;c.Label.String = 'Local similarity';c.Label.FontSize = 16;%c.Label.FontWeight = bold;
caxis([0,1]);
ylabel('Time (s)','Fontsize',12,'fontweight','bold');
xlabel('Trace','Fontsize',12,'fontweight','bold');
set(gca,'Linewidth',2,'Fontsize',15,'Fontweight','bold');

print(gcf,'-depsc','-r300','fig13.eps');